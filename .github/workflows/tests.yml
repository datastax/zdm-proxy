name: ZDM Tests
on: push
jobs:
  nosqlbench-tests:
    name: NoSQLBench Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Start docker-compose
        run: |
          docker-compose -f docker-compose-tests.yml up -d
          sleep 720
          docker-compose -f docker-compose-tests.yml logs
          docker ps -a
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run
        run: |
          sudo apt update
          sudo apt -y install default-jre gcc git wget
          wget https://go.dev/dl/go1.19.linux-amd64.tar.gz
          sudo tar -xzf go*.tar.gz -C /usr/local/
          export PATH=$PATH:/usr/local/go/bin
          export PATH=$PATH:`go env GOPATH`/bin
          go install github.com/jstemmer/go-junit-report/v2@latest
          go test -v 2>&1 ./proxy/... | go-junit-report -set-exit-code -iocopy -out report-unit.xml
      - name: Test Summary
        uses: test-summary/action@v1
        if: always()
        with:
          paths: |
            report-unit.xml
  integration-tests-simulacron:
    name: Simulacron Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run
        run: |
          sudo apt update
          sudo apt -y install openjdk-8-jdk gcc git wget
          wget https://go.dev/dl/go1.19.linux-amd64.tar.gz
          sudo tar -xzf go*.tar.gz -C /usr/local/
          export PATH=$PATH:/usr/local/go/bin
          export PATH=$PATH:`go env GOPATH`/bin
          go install github.com/jstemmer/go-junit-report/v2@latest
          wget https://github.com/datastax/simulacron/releases/download/0.10.0/simulacron-standalone-0.10.0.jar
          export SIMULACRON_PATH=`pwd`/simulacron-standalone-0.10.0.jar
          go test -timeout 180m -v 2>&1 ./integration-tests | go-junit-report -set-exit-code -iocopy -out report-integration-simulacron.xml
      - name: Test Summary
        uses: test-summary/action@v1
        if: always()
        with:
          paths: |
            report-integration-simulacron.xml
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run
        run: |
          sudo apt update
          sudo apt -y install openjdk-8-jdk gcc git wget pip
          wget https://go.dev/dl/go1.19.linux-amd64.tar.gz
          sudo tar -xzf go*.tar.gz -C /usr/local/
          export PATH=$PATH:/usr/local/go/bin
          export PATH=$PATH:`go env GOPATH`/bin
          export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH
          java -version
          go install github.com/jstemmer/go-junit-report/v2@latest
          wget https://github.com/datastax/simulacron/releases/download/0.10.0/simulacron-standalone-0.10.0.jar
          export SIMULACRON_PATH=`pwd`/simulacron-standalone-0.10.0.jar
          pip install ccm
          which ccm
          sudo ln -s /home/runner/.local/bin/ccm /usr/local/bin/ccm
          /usr/local/bin/ccm list
          go test -timeout 180m -v 2>&1 ./integration-tests -SKIP_SIMULACRON=true -USE_CCM=true | go-junit-report -set-exit-code -iocopy -out report-integration.xml
      - name: Test Summary
        uses: test-summary/action@v1
        if: always()
        with:
          paths: |
            report-integration.xml
  race-checker:
    name: Race Checker
    runs-on: ubuntu-latest
    if: ${{ false }} # temporarily disabled
    steps:
      - uses: actions/checkout@v2
      - name: Run
        run: |
          sudo apt update
          sudo apt -y install openjdk-8-jdk gcc git pip wget
          wget https://go.dev/dl/go1.19.linux-amd64.tar.gz
          sudo tar -xzf go*.tar.gz -C /usr/local/
          export PATH=$PATH:/usr/local/go/bin
          export PATH=$PATH:`go env GOPATH`/bin
          go install github.com/jstemmer/go-junit-report/v2@latest
          wget https://github.com/datastax/simulacron/releases/download/0.10.0/simulacron-standalone-0.10.0.jar
          export SIMULACRON_PATH=`pwd`/simulacron-standalone-0.10.0.jar
          go test -race -timeout 180m -v 2>&1 ./integration-tests | go-junit-report -set-exit-code -iocopy -out report-integration-race.xml
      - name: Test Summary
        uses: test-summary/action@v1
        if: always()
        with:
          paths: |
            report-integration-race.xml
  go-vet:
    name: Go Vet
    runs-on: ubuntu-latest
    if: ${{ false }} # temporarily disabled
    steps:
      - uses: actions/checkout@v2
      - name: Run
        run: |
          sudo apt update
          sudo apt -y install openjdk-8-jdk gcc git pip wget
          wget https://go.dev/dl/go1.19.linux-amd64.tar.gz
          sudo tar -xzf go*.tar.gz -C /usr/local/
          export PATH=$PATH:/usr/local/go/bin
          export PATH=$PATH:`go env GOPATH`/bin
          go vet ./...
  static-check:
    name: Static Check
    runs-on: ubuntu-latest
    if: ${{ false }} # temporarily disabled
    steps:
      - uses: actions/checkout@v2
      - name: Run
        run: |
          sudo apt update
          sudo apt -y install openjdk-8-jdk gcc git pip wget
          wget https://go.dev/dl/go1.19.linux-amd64.tar.gz
          sudo tar -xzf go*.tar.gz -C /usr/local/
          export PATH=$PATH:/usr/local/go/bin
          export PATH=$PATH:`go env GOPATH`/bin
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...